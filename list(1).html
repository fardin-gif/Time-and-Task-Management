<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity History - Time Tracker</title>
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/1156/1156961.png" type="image/x-icon">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #0fccce;
            --accent-dark: #0db9bb;
            --text: #e6e6e6;
            --text-secondary: #a0a0a0;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-radius: 16px;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto Condensed', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
        }

        h1 {
            font-size: 2.4rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--accent), #4deeea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .nav-btn {
            position: absolute;
            top: 25px;
            left: 25px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
        }

        /* Accuracy Dashboard Styles */
        .accuracy-dashboard {
            margin-bottom: 30px;
        }

        .accuracy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .accuracy-title {
            font-size: 1.3rem;
            color: var(--accent);
            font-weight: 600;
        }

        .date-selector-small {
            display: flex;
            gap: 10px;
        }

        .date-btn-small {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .date-btn-small.active {
            background: var(--accent);
            color: var(--primary);
            font-weight: 600;
        }

        .accuracy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .accuracy-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--accent);
        }

        .accuracy-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .accuracy-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .accuracy-bar-container {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .accuracy-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }

        .performance-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .performance-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge-productive {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .badge-neutral {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .badge-waste {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        /* Timeline View */
        .timeline-container {
            margin-top: 25px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timeline-day {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            position: relative;
            height: 100px;
            margin-bottom: 10px;
        }

        .timeline-hour-marks {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .timeline-hour {
            flex: 1;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .timeline-hour-label {
            position: absolute;
            top: -25px;
            left: 0;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .timeline-activity {
            position: absolute;
            border-radius: 4px;
            opacity: 0.8;
            transition: var(--transition);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .timeline-activity:hover {
            opacity: 1;
            transform: scaleY(1.1);
            z-index: 10;
        }

        .timeline-activity.productive {
            background: rgba(76, 175, 80, 0.6);
        }

        .timeline-activity.neutral {
            background: rgba(255, 193, 7, 0.6);
        }

        .timeline-activity.waste {
            background: rgba(244, 67, 54, 0.6);
        }

        .timeline-activity.overlap {
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255, 255, 255, 0.1) 5px,
                rgba(255, 255, 255, 0.1) 10px
            );
            border-color: var(--warning);
        }

        .timeline-gap {
            position: absolute;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--accent);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent);
            font-size: 1.05rem;
        }

        .select-wrapper {
            position: relative;
            width: 100%;
        }

        .select-wrapper::after {
            content: "â–¼";
            font-size: 12px;
            color: var(--accent);
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            transition: var(--transition);
        }

        select {
            width: 100%;
            padding: 15px 18px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: var(--text);
            font-size: 16px;
            transition: var(--transition);
            font-weight: 400;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(15, 204, 206, 0.2);
            background: rgba(255, 255, 255, 0.12);
        }

        select option {
            background: var(--secondary);
            color: var(--text);
            padding: 12px;
        }

        input {
            width: 100%;
            padding: 15px 18px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: var(--text);
            font-size: 16px;
            transition: var(--transition);
            font-weight: 400;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(15, 204, 206, 0.2);
            background: rgba(255, 255, 255, 0.12);
        }

        .activities-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .activity-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border-left: 4px solid var(--accent);
            position: relative;
        }

        .activity-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .activity-item.overlap {
            border-left-color: var(--warning);
            background: rgba(255, 152, 0, 0.05);
        }

        .activity-main {
            flex: 1;
        }

        .activity-task {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 5px;
        }

        .activity-meta {
            display: flex;
            gap: 15px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .activity-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .activity-side {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .activity-duration {
            background: rgba(15, 204, 206, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .efficiency-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .efficiency--3 { background: #F44336; color: white; }
        .efficiency--2 { background: #FF5722; color: white; }
        .efficiency--1 { background: #FF9800; color: black; }
        .efficiency-0 { background: #FFC107; color: black; }
        .efficiency-1 { background: #8BC34A; color: black; }
        .efficiency-2 { background: #4CAF50; color: white; }
        .efficiency-3 { background: #2E7D32; color: white; }

        .activity-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .edit-btn {
            background: rgba(15, 204, 206, 0.1);
            color: var(--accent);
            border: 1px solid rgba(15, 204, 206, 0.3);
        }

        .edit-btn:hover {
            background: rgba(15, 204, 206, 0.2);
            transform: translateY(-2px);
        }

        .delete-btn {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .delete-btn:hover {
            background: rgba(244, 67, 54, 0.2);
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .date-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .task-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-name {
            font-weight: 500;
        }

        .task-stats {
            text-align: right;
        }

        .task-duration {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .task-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--secondary);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transform: scale(0.9);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--accent);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--text);
        }

        /* Delete Confirmation Popup */
        .popup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .popup-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
        }

        .popup-btn.confirm {
            background: var(--danger);
            color: white;
        }

        .popup-btn.confirm:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .popup-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }

        .popup-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .page-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            transition: var(--transition);
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
        }

        .page-btn.active {
            background: var(--accent);
            color: var(--primary);
            font-weight: 600;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .activity-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .activity-side {
                width: 100%;
                justify-content: space-between;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters {
                flex-direction: column;
            }

            .nav-btn {
                position: static;
                margin-bottom: 15px;
                width: 100%;
                justify-content: center;
            }

            .accuracy-grid {
                grid-template-columns: 1fr;
            }

            .timeline-day {
                height: 80px;
            }

            .timeline-hour-label {
                font-size: 0.7rem;
                top: -20px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .activity-meta {
                flex-direction: column;
                gap: 5px;
            }

            .activity-actions {
                width: 100%;
                justify-content: space-between;
            }

            .action-btn {
                flex: 1;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="nav-btn">
                <i class="fas fa-arrow-left"></i> Back to Tracker
            </a>
            <h1><i class="fas fa-history"></i> Activity History</h1>
        </header>

        <!-- Accuracy Dashboard -->
        <div class="card accuracy-dashboard">
            <div class="accuracy-header">
                <h2 class="accuracy-title">Accuracy Dashboard</h2>
                <div class="date-selector-small" id="accuracyDateSelector">
                    <button class="date-btn-small active" data-range="today">Today</button>
                    <button class="date-btn-small" data-range="yesterday">Yesterday</button>
                    <button class="date-btn-small" data-range="week">Last 7 Days</button>
                    <button class="date-btn-small" data-range="month">Last 30 Days</button>
                </div>
            </div>
            
            <div class="accuracy-grid" id="accuracyGrid">
                <!-- Accuracy metrics will be loaded here -->
            </div>

            <div class="timeline-container" id="timelineContainer" style="display: none;">
                <div class="timeline-header">
                    <h3 style="color: var(--accent);">Daily Timeline</h3>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        <span style="display: inline-block; width: 12px; height: 12px; background: #4CAF50; border-radius: 2px; margin-right: 5px;"></span> Productive
                        <span style="display: inline-block; width: 12px; height: 12px; background: #FFC107; border-radius: 2px; margin: 0 5px 0 15px;"></span> Neutral
                        <span style="display: inline-block; width: 12px; height: 12px; background: #F44336; border-radius: 2px; margin: 0 5px 0 15px;"></span> Waste
                    </div>
                </div>
                <div class="timeline-day" id="timelineDay">
                    <!-- Timeline will be generated here -->
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="card">
            <h2 style="margin-bottom: 20px; color: var(--accent);">Summary Overview</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalActivities">0</div>
                    <div class="stat-label">Total Activities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalHours">0h 0m</div>
                    <div class="stat-label">Total Time Tracked</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgEfficiency">0.0</div>
                    <div class="stat-label">Average Efficiency</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="productiveHours">0h 0m</div>
                    <div class="stat-label">Productive Time</div>
                </div>
            </div>

            <h3 style="margin: 25px 0 15px; color: var(--accent);">Task Breakdown</h3>
            <div class="task-breakdown" id="taskBreakdown">
                <!-- Task breakdown will be populated here -->
            </div>
        </div>

        <!-- Filters -->
        <div class="card">
            <h2 style="margin-bottom: 15px; color: var(--accent);">Filter Activities</h2>
            <div class="filters">
                <div class="filter-group">
                    <label for="dateFilter">Date Range</label>
                    <div class="select-wrapper">
                        <select id="dateFilter">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
                <div class="filter-group" id="customDateRange" style="display: none;">
                    <label for="startDate">From Date</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group" id="customDateRangeEnd" style="display: none;">
                    <label for="endDate">To Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="filter-group">
                    <label for="taskFilter">Task Type</label>
                    <div class="select-wrapper">
                        <select id="taskFilter">
                            <option value="all">All Tasks</option>
                            <!-- Tasks will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="efficiencyFilter">Efficiency</label>
                    <div class="select-wrapper">
                        <select id="efficiencyFilter">
                            <option value="all">All Ratings</option>
                            <option value="-3">Khub ii faltu (-3)</option>
                            <option value="-2">Faltu (-2)</option>
                            <option value="-1">Blunder (-1)</option>
                            <option value="0">Average (0)</option>
                            <option value="1">Good (1)</option>
                            <option value="2">Best (2)</option>
                            <option value="3">Awesome (3)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activities List -->
        <div class="card">
            <h2 style="margin-bottom: 15px; color: var(--accent);">Activity History</h2>
            <div id="activitiesContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading your activities...</p>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="pagination" style="display: none;">
                <button class="page-btn" id="prevPageBtn" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="pageInfo" style="color: var(--text-secondary);">Page 1 of 1</span>
                <button class="page-btn" id="nextPageBtn" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Activity Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Activity</h2>
                <button class="modal-close" id="closeEditModal">&times;</button>
            </div>
            <div id="editFormContainer">
                <!-- Edit form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Popup -->
    <div class="modal-overlay" id="deleteConfirmationPopup">
        <div class="modal">
            <div style="text-align: center;">
                <div style="font-size: 60px; margin-bottom: 20px; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h2 class="modal-title">Delete Activity</h2>
                <p style="color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6;">Are you sure you want to delete this activity? This action cannot be undone.</p>
                <div class="popup-buttons">
                    <button class="popup-btn cancel" id="cancelDelete">Cancel</button>
                    <button class="popup-btn confirm" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // Firebase Configuration
        // ============================
        const firebaseConfig = {
            apiKey: "AIzaSyB94_Y4ox7f0OvPlTZ2kQ-RQQoAbhlp0CU",
            authDomain: "time-and-task-management-2d8c3.firebaseapp.com",
            projectId: "time-and-task-management-2d8c3",
            storageBucket: "time-and-task-management-2d8c3.firebasestorage.app",
            messagingSenderId: "987578072001",
            appId: "1:987578072001:web:f10a27db2b915690364d40"
        };

        // Initialize Firebase
        let app;
        let db;
        
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Firebase initialization failed. Check console for details.");
        }

        // ============================
        // DOM Elements
        // ============================
        const activitiesContainer = document.getElementById('activitiesContainer');
        const dateFilter = document.getElementById('dateFilter');
        const taskFilter = document.getElementById('taskFilter');
        const efficiencyFilter = document.getElementById('efficiencyFilter');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const customDateRange = document.getElementById('customDateRange');
        const customDateRangeEnd = document.getElementById('customDateRangeEnd');
        const deleteConfirmationPopup = document.getElementById('deleteConfirmationPopup');
        const cancelDeleteBtn = document.getElementById('cancelDelete');
        const confirmDeleteBtn = document.getElementById('confirmDelete');
        const editModal = document.getElementById('editModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const editFormContainer = document.getElementById('editFormContainer');

        // Statistics elements
        const totalActivitiesEl = document.getElementById('totalActivities');
        const totalHoursEl = document.getElementById('totalHours');
        const avgEfficiencyEl = document.getElementById('avgEfficiency');
        const productiveHoursEl = document.getElementById('productiveHours');
        const taskBreakdownEl = document.getElementById('taskBreakdown');

        // Accuracy dashboard elements
        const accuracyDateSelector = document.getElementById('accuracyDateSelector');
        const accuracyGrid = document.getElementById('accuracyGrid');
        const timelineContainer = document.getElementById('timelineContainer');
        const timelineDay = document.getElementById('timelineDay');

        // Pagination elements
        const pagination = document.getElementById('pagination');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        // ============================
        // State Variables
        // ============================
        let allActivities = [];
        let filteredActivities = [];
        let currentPage = 1;
        const pageSize = 20;
        let activityToDelete = null;
        let activityToEdit = null;
        let currentAccuracyRange = 'today';

        // Set default dates for custom filter
        const today = new Date();
        const oneWeekAgo = new Date(today);
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        
        startDateInput.valueAsDate = oneWeekAgo;
        endDateInput.valueAsDate = today;

        // ============================
        // Utility Functions
        // ============================
        function getEfficiencyText(efficiency) {
            const efficiencyMap = {
                '-3': 'Khub ii faltu',
                '-2': 'Faltu',
                '-1': 'Blunder',
                '0': 'Average',
                '1': 'Good',
                '2': 'Best',
                '3': 'Awesome'
            };
            return efficiencyMap[efficiency.toString()] || 'Unknown';
        }

        function getEfficiencyCategory(efficiency) {
            if (efficiency >= 1) return 'productive';
            if (efficiency === 0) return 'neutral';
            return 'waste';
        }

        function formatDuration(minutes) {
            if (!minutes) return '0h 0m';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        function formatDurationHours(minutes) {
            if (!minutes) return '0';
            return (minutes / 60).toFixed(1);
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatDateShort(date) {
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTime(timeString) {
            if (!timeString) return 'Unknown';
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes.padStart(2, '0')} ${ampm}`;
        }

        function getDateTimeFromActivity(activity) {
            // Handle both old and new data models
            let startDate, endDate;
            
            if (activity.startAt && activity.startAt.toDate) {
                // New model
                startDate = activity.startAt.toDate();
                endDate = activity.endAt ? activity.endAt.toDate() : new Date(startDate.getTime() + (activity.duration || 0) * 60000);
            } else if (activity.date && activity.date.toDate) {
                // Old model
                startDate = activity.date.toDate();
                const [hours, minutes] = activity.timeFrom.split(':').map(Number);
                startDate.setHours(hours, minutes, 0, 0);
                
                endDate = new Date(startDate);
                const [endHours, endMinutes] = activity.timeTo.split(':').map(Number);
                endDate.setHours(endHours, endMinutes, 0, 0);
                
                // Handle spanning midnight
                if (endDate < startDate) {
                    endDate.setDate(endDate.getDate() + 1);
                }
            } else {
                // Fallback
                startDate = new Date();
                endDate = new Date(startDate.getTime() + 60 * 60000);
            }
            
            return { startDate, endDate };
        }

        // ============================
        // Date Range Functions
        // ============================
        function getDateRange() {
            const filterValue = dateFilter.value;
            const start = new Date();
            const end = new Date();
            
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            
            switch(filterValue) {
                case 'today':
                    return { start, end };
                case 'yesterday':
                    start.setDate(start.getDate() - 1);
                    end.setDate(end.getDate() - 1);
                    return { start, end };
                case 'week':
                    start.setDate(start.getDate() - start.getDay());
                    return { start, end };
                case 'month':
                    start.setDate(1);
                    return { start, end };
                case 'custom':
                    const customStart = new Date(startDateInput.value);
                    const customEnd = new Date(endDateInput.value);
                    customStart.setHours(0, 0, 0, 0);
                    customEnd.setHours(23, 59, 59, 999);
                    return { start: customStart, end: customEnd };
                default:
                    return null; // All time
            }
        }

        function getAccuracyDateRange(range) {
            const start = new Date();
            const end = new Date();
            
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            
            switch(range) {
                case 'today':
                    return { start, end, label: 'Today' };
                case 'yesterday':
                    start.setDate(start.getDate() - 1);
                    end.setDate(end.getDate() - 1);
                    return { start, end, label: 'Yesterday' };
                case 'week':
                    start.setDate(start.getDate() - 7);
                    return { start, end, label: 'Last 7 Days' };
                case 'month':
                    start.setDate(start.getDate() - 30);
                    return { start, end, label: 'Last 30 Days' };
                default:
                    return { start, end, label: 'Today' };
            }
        }

        // ============================
        // Accuracy Calculations
        // ============================
        function calculateAccuracyMetrics(activities, dateRange) {
            if (!activities.length) {
                return {
                    coveragePercent: 0,
                    gapMinutes: 1440,
                    trackedMinutes: 0,
                    performanceScore: 0,
                    productiveMinutes: 0,
                    neutralMinutes: 0,
                    wasteMinutes: 0,
                    positiveRatioPercent: 0,
                    wasteRatioPercent: 0,
                    totalTrackedMinutes: 0
                };
            }

            // Filter activities for the selected day
            const dayActivities = activities.filter(activity => {
                const { startDate, endDate } = getDateTimeFromActivity(activity);
                return startDate <= dateRange.end && endDate >= dateRange.start;
            });

            if (!dayActivities.length) {
                return {
                    coveragePercent: 0,
                    gapMinutes: 1440,
                    trackedMinutes: 0,
                    performanceScore: 0,
                    productiveMinutes: 0,
                    neutralMinutes: 0,
                    wasteMinutes: 0,
                    positiveRatioPercent: 0,
                    wasteRatioPercent: 0,
                    totalTrackedMinutes: 0
                };
            }

            // Create intervals for overlap detection
            const intervals = [];
            dayActivities.forEach(activity => {
                const { startDate, endDate } = getDateTimeFromActivity(activity);
                
                // Clip interval to the selected day
                const intervalStart = Math.max(startDate.getTime(), dateRange.start.getTime());
                const intervalEnd = Math.min(endDate.getTime(), dateRange.end.getTime());
                
                if (intervalStart < intervalEnd) {
                    intervals.push({
                        start: intervalStart,
                        end: intervalEnd,
                        efficiency: activity.efficiency || 0,
                        duration: (intervalEnd - intervalStart) / 60000 // Convert to minutes
                    });
                }
            });

            // Sort intervals by start time
            intervals.sort((a, b) => a.start - b.start);

            // Merge overlapping intervals for coverage calculation
            const mergedIntervals = [];
            let currentInterval = null;

            intervals.forEach(interval => {
                if (!currentInterval) {
                    currentInterval = { ...interval };
                } else if (interval.start <= currentInterval.end) {
                    // Overlapping intervals
                    currentInterval.end = Math.max(currentInterval.end, interval.end);
                    // For merged intervals, we'll track efficiency separately
                } else {
                    mergedIntervals.push(currentInterval);
                    currentInterval = { ...interval };
                }
            });

            if (currentInterval) {
                mergedIntervals.push(currentInterval);
            }

            // Calculate coverage
            let trackedMinutes = 0;
            mergedIntervals.forEach(interval => {
                trackedMinutes += (interval.end - interval.start) / 60000;
            });

            const gapMinutes = 1440 - trackedMinutes;
            const coveragePercent = (trackedMinutes / 1440) * 100;

            // Calculate performance metrics
            let totalWeightedScore = 0;
            let productiveMinutes = 0;
            let neutralMinutes = 0;
            let wasteMinutes = 0;
            let totalTrackedMinutes = 0;

            intervals.forEach(interval => {
                const minutes = interval.duration;
                const efficiency = interval.efficiency;
                
                totalWeightedScore += minutes * efficiency;
                totalTrackedMinutes += minutes;
                
                if (efficiency >= 1) {
                    productiveMinutes += minutes;
                } else if (efficiency === 0) {
                    neutralMinutes += minutes;
                } else {
                    wasteMinutes += minutes;
                }
            });

            const performanceScore = totalTrackedMinutes > 0 ? totalWeightedScore / totalTrackedMinutes : 0;
            const positiveRatioPercent = totalTrackedMinutes > 0 ? (productiveMinutes / totalTrackedMinutes) * 100 : 0;
            const wasteRatioPercent = totalTrackedMinutes > 0 ? (wasteMinutes / totalTrackedMinutes) * 100 : 0;

            return {
                coveragePercent,
                gapMinutes,
                trackedMinutes,
                performanceScore,
                productiveMinutes,
                neutralMinutes,
                wasteMinutes,
                positiveRatioPercent,
                wasteRatioPercent,
                totalTrackedMinutes,
                intervals: dayActivities,
                mergedIntervals
            };
        }

        function renderAccuracyDashboard(metrics, dateRange) {
            const { 
                coveragePercent, 
                gapMinutes, 
                performanceScore, 
                productiveMinutes, 
                neutralMinutes, 
                wasteMinutes,
                positiveRatioPercent,
                wasteRatioPercent,
                totalTrackedMinutes,
                intervals,
                mergedIntervals
            } = metrics;

            // Format values
            const gapHours = Math.floor(gapMinutes / 60);
            const gapMins = Math.floor(gapMinutes % 60);
            const gapText = gapMinutes > 0 ? `(${gapHours}h ${gapMins}m untracked)` : '(Fully tracked)';

            const productiveHours = (productiveMinutes / 60).toFixed(1);
            const neutralHours = (neutralMinutes / 60).toFixed(1);
            const wasteHours = (wasteMinutes / 60).toFixed(1);

            // Update accuracy grid
            accuracyGrid.innerHTML = `
                <div class="accuracy-card">
                    <div class="accuracy-value">${coveragePercent.toFixed(1)}%</div>
                    <div class="accuracy-label">Tracking Coverage ${gapText}</div>
                    <div class="accuracy-bar-container">
                        <div class="accuracy-bar" style="width: ${Math.min(coveragePercent, 100)}%"></div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
                        ${formatDuration(totalTrackedMinutes)} tracked of 24h
                    </div>
                </div>
                
                <div class="accuracy-card">
                    <div class="accuracy-value">${performanceScore.toFixed(1)}</div>
                    <div class="accuracy-label">Performance Score</div>
                    <div class="performance-badges">
                        <div class="performance-badge badge-productive">
                            <i class="fas fa-arrow-up"></i> ${positiveRatioPercent.toFixed(0)}% Productive
                        </div>
                        <div class="performance-badge badge-waste">
                            <i class="fas fa-arrow-down"></i> ${wasteRatioPercent.toFixed(0)}% Waste
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
                        Score range: -3 (waste) to +3 (excellent)
                    </div>
                </div>
                
                <div class="accuracy-card">
                    <div class="accuracy-value">${productiveHours}h</div>
                    <div class="accuracy-label">Productive Time (1-3)</div>
                    <div class="accuracy-bar-container">
                        <div class="accuracy-bar" style="width: ${positiveRatioPercent}%; background: #4CAF50;"></div>
                    </div>
                    
                    <div class="accuracy-value" style="font-size: 1.2rem; margin-top: 15px;">${neutralHours}h</div>
                    <div class="accuracy-label">Neutral Time (0)</div>
                    <div class="accuracy-bar-container">
                        <div class="accuracy-bar" style="width: ${(neutralMinutes / totalTrackedMinutes * 100) || 0}%; background: #FFC107;"></div>
                    </div>
                    
                    <div class="accuracy-value" style="font-size: 1.2rem; margin-top: 15px;">${wasteHours}h</div>
                    <div class="accuracy-label">Waste Time (-1 to -3)</div>
                    <div class="accuracy-bar-container">
                        <div class="accuracy-bar" style="width: ${wasteRatioPercent}%; background: #F44336;"></div>
                    </div>
                </div>
            `;

            // Show/hide timeline based on date range
            if (dateRange === 'today' || dateRange === 'yesterday') {
                timelineContainer.style.display = 'block';
                renderTimeline(intervals, mergedIntervals);
            } else {
                timelineContainer.style.display = 'none';
            }
        }

        function renderTimeline(activities, mergedIntervals) {
            timelineDay.innerHTML = '';
            
            // Create hour marks
            const hourMarks = document.createElement('div');
            hourMarks.className = 'timeline-hour-marks';
            
            for (let hour = 0; hour < 24; hour++) {
                const hourMark = document.createElement('div');
                hourMark.className = 'timeline-hour';
                
                const label = document.createElement('div');
                label.className = 'timeline-hour-label';
                label.textContent = hour === 0 ? '12 AM' : hour === 12 ? '12 PM' : hour > 12 ? `${hour - 12} PM` : `${hour} AM`;
                
                hourMark.appendChild(label);
                hourMarks.appendChild(hourMark);
            }
            
            timelineDay.appendChild(hourMarks);
            
            // Render activities
            activities.forEach((activity, index) => {
                const { startDate, endDate } = getDateTimeFromActivity(activity);
                
                // Calculate positions (percentage of 24 hours)
                const startHour = startDate.getHours() + startDate.getMinutes() / 60;
                const endHour = endDate.getHours() + endDate.getMinutes() / 60;
                
                const left = (startHour / 24) * 100;
                const width = ((endHour - startHour) / 24) * 100;
                
                if (width > 0) {
                    const activityDiv = document.createElement('div');
                    activityDiv.className = `timeline-activity ${getEfficiencyCategory(activity.efficiency || 0)}`;
                    if (activity.overlapFlag) {
                        activityDiv.classList.add('overlap');
                    }
                    
                    activityDiv.style.left = `${left}%`;
                    activityDiv.style.width = `${width}%`;
                    activityDiv.style.top = '20px';
                    activityDiv.style.height = '40px';
                    
                    // Tooltip
                    activityDiv.title = `${activity.taskName || activity.task}\n${formatTime(activity.timeFrom)} - ${formatTime(activity.timeTo)}\nEfficiency: ${activity.efficiency}`;
                    
                    timelineDay.appendChild(activityDiv);
                }
            });
            
            // Render gaps (untracked time)
            const dayStart = new Date();
            dayStart.setHours(0, 0, 0, 0);
            const dayEnd = new Date();
            dayEnd.setHours(23, 59, 59, 999);
            
            let lastEnd = dayStart.getTime();
            
            mergedIntervals.forEach(interval => {
                const gapStart = lastEnd;
                const gapEnd = interval.start;
                
                if (gapEnd > gapStart) {
                    const gapDuration = (gapEnd - gapStart) / (1000 * 60 * 60); // Hours
                    const gapLeft = ((gapStart - dayStart.getTime()) / (24 * 60 * 60 * 1000)) * 100;
                    const gapWidth = (gapDuration / 24) * 100;
                    
                    if (gapWidth > 0.1) { // Only show gaps wider than 0.1%
                        const gapDiv = document.createElement('div');
                        gapDiv.className = 'timeline-gap';
                        gapDiv.style.left = `${gapLeft}%`;
                        gapDiv.style.width = `${gapWidth}%`;
                        gapDiv.style.top = '65px';
                        gapDiv.style.height = '10px';
                        
                        const gapMinutes = (gapEnd - gapStart) / (1000 * 60);
                        gapDiv.title = `Untracked: ${formatDuration(gapMinutes)}`;
                        
                        timelineDay.appendChild(gapDiv);
                    }
                }
                
                lastEnd = Math.max(lastEnd, interval.end);
            });
            
            // Final gap after last activity
            if (lastEnd < dayEnd.getTime()) {
                const gapDuration = (dayEnd.getTime() - lastEnd) / (1000 * 60 * 60);
                const gapLeft = ((lastEnd - dayStart.getTime()) / (24 * 60 * 60 * 1000)) * 100;
                const gapWidth = (gapDuration / 24) * 100;
                
                if (gapWidth > 0.1) {
                    const gapDiv = document.createElement('div');
                    gapDiv.className = 'timeline-gap';
                    gapDiv.style.left = `${gapLeft}%`;
                    gapDiv.style.width = `${gapWidth}%`;
                    gapDiv.style.top = '65px';
                    gapDiv.style.height = '10px';
                    
                    const gapMinutes = (dayEnd.getTime() - lastEnd) / (1000 * 60);
                    gapDiv.title = `Untracked: ${formatDuration(gapMinutes)}`;
                    
                    timelineDay.appendChild(gapDiv);
                }
            }
        }

        // ============================
        // Activity Management
        // ============================
        function populateTaskFilter(activities) {
            // Get unique tasks from activities
            const tasks = [...new Set(activities.map(activity => activity.taskName || activity.task))].sort();
            
            // Clear existing options except the first one
            while (taskFilter.options.length > 1) {
                taskFilter.remove(1);
            }
            
            // Add tasks to the filter
            tasks.forEach(task => {
                if (task) {
                    const option = document.createElement('option');
                    option.value = task;
                    option.textContent = task;
                    taskFilter.appendChild(option);
                }
            });
        }

        async function loadActivities() {
            console.log("Starting to load activities...");
            
            activitiesContainer.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading your activities...</p>
                </div>
            `;

            try {
                if (!db) {
                    throw new Error("Firebase not initialized");
                }

                let query = db.collection('activities').orderBy('startAt', 'desc');
                
                // Apply date filter
                const dateRange = getDateRange();
                if (dateRange) {
                    console.log("Applying date filter:", dateRange);
                    query = query.where('startAt', '>=', firebase.firestore.Timestamp.fromDate(dateRange.start))
                                 .where('startAt', '<=', firebase.firestore.Timestamp.fromDate(dateRange.end));
                }
                
                // Apply task filter
                const taskValue = taskFilter.value;
                if (taskValue !== 'all') {
                    console.log("Applying task filter:", taskValue);
                    query = query.where('taskName', '==', taskValue);
                }
                
                // Apply efficiency filter
                const efficiencyValue = efficiencyFilter.value;
                if (efficiencyValue !== 'all') {
                    console.log("Applying efficiency filter:", efficiencyValue);
                    query = query.where('efficiency', '==', parseInt(efficiencyValue));
                }
                
                console.log("Executing Firestore query...");
                const snapshot = await query.get();
                console.log("Query completed, found", snapshot.size, "documents");
                
                allActivities = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log("Processing document:", doc.id, data);
                    
                    allActivities.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                console.log("Processed activities:", allActivities.length);
                
                // Apply client-side filtering for old data model compatibility
                filterAndDisplayActivities();
                
            } catch (error) {
                console.error('Error loading activities: ', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                
                activitiesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error loading activities</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Check browser console for details</p>
                    </div>
                `;
            }
        }

        function filterAndDisplayActivities() {
            // Apply any additional client-side filters if needed
            filteredActivities = [...allActivities];
            
            // Update statistics
            updateStatistics(filteredActivities);
            
            // Populate task filter
            populateTaskFilter(filteredActivities);
            
            // Update accuracy dashboard
            updateAccuracyDashboard();
            
            // Display paginated activities
            displayPaginatedActivities();
        }

        function displayPaginatedActivities() {
            if (!filteredActivities || filteredActivities.length === 0) {
                activitiesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No activities found</h3>
                        <p>Try adjusting your filters or add some activities in the tracker.</p>
                    </div>
                `;
                pagination.style.display = 'none';
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(filteredActivities.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredActivities.length);
            const pageActivities = filteredActivities.slice(startIndex, endIndex);

            // Group activities by date
            const activitiesByDate = {};
            pageActivities.forEach(activity => {
                const { startDate } = getDateTimeFromActivity(activity);
                const date = startDate.toDateString();
                if (!activitiesByDate[date]) {
                    activitiesByDate[date] = [];
                }
                activitiesByDate[date].push(activity);
            });
            
            let html = '';
            
            // Display activities grouped by date
            Object.keys(activitiesByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                const dateObj = new Date(date);
                html += `<div class="date-header">${formatDate(dateObj)}</div>`;
                
                activitiesByDate[date].forEach(activity => {
                    const { startDate, endDate } = getDateTimeFromActivity(activity);
                    const duration = activity.duration ? formatDuration(activity.duration) : '0h 0m';
                    
                    // Handle both old and new data models
                    const taskName = activity.taskName || activity.task || 'Unknown Task';
                    const notes = activity.notes || activity.progress || '';
                    const overlapFlag = activity.overlapFlag || false;
                    
                    html += `
                        <div class="activity-item ${overlapFlag ? 'overlap' : ''}">
                            <div class="activity-main">
                                <div class="activity-task">${taskName}</div>
                                <div class="activity-meta">
                                    <span><i class="far fa-clock"></i> ${startDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${endDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                    <span><i class="far fa-calendar"></i> ${startDate.toLocaleDateString()}</span>
                                    ${notes ? `<span><i class="far fa-sticky-note"></i> ${notes.substring(0, 50)}${notes.length > 50 ? '...' : ''}</span>` : ''}
                                    ${overlapFlag ? `<span><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Overlap</span>` : ''}
                                </div>
                            </div>
                            <div class="activity-side">
                                <div class="activity-duration">${duration}</div>
                                <div class="efficiency-badge efficiency-${activity.efficiency}">
                                    ${getEfficiencyText(activity.efficiency)} (${activity.efficiency})
                                </div>
                                <div class="activity-actions">
                                    <button class="action-btn edit-btn" data-id="${activity.id}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="action-btn delete-btn" data-id="${activity.id}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
            
            activitiesContainer.innerHTML = html;
            
            // Update pagination controls
            updatePaginationControls(totalPages);
            
            // Add event listeners
            addActivityEventListeners();
        }

        function updatePaginationControls(totalPages) {
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        }

        function addActivityEventListeners() {
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const activityId = this.getAttribute('data-id');
                    showEditModal(activityId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const activityId = this.getAttribute('data-id');
                    showDeleteConfirmation(activityId);
                });
            });
        }

        function showDeleteConfirmation(activityId) {
            activityToDelete = activityId;
            deleteConfirmationPopup.classList.add('active');
        }

        async function showEditModal(activityId) {
            activityToEdit = allActivities.find(a => a.id === activityId);
            if (!activityToEdit) return;
            
            const { startDate, endDate } = getDateTimeFromActivity(activityToEdit);
            
            // Create edit form
            const formHtml = `
                <form id="editActivityForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--accent);">Task</label>
                        <input type="text" id="editTask" value="${activityToEdit.taskName || activityToEdit.task}" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); color: var(--text);" required>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--accent);">Date</label>
                        <input type="date" id="editDate" value="${startDate.toISOString().split('T')[0]}" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); color: var(--text);" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--accent);">Start Time</label>
                            <input type="time" id="editTimeFrom" value="${startDate.getHours().toString().padStart(2, '0')}:${startDate.getMinutes().toString().padStart(2, '0')}" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); color: var(--text);" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: var(--accent);">End Time</label>
                            <input type="time" id="editTimeTo" value="${endDate.getHours().toString().padStart(2, '0')}:${endDate.getMinutes().toString().padStart(2, '0')}" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); color: var(--text);" required>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--accent);">Efficiency</label>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                            ${[-3, -2, -1, 0, 1, 2, 3].map(val => `
                                <button type="button" class="efficiency-edit-btn" data-value="${val}" style="padding: 10px; border-radius: 8px; background: ${val === activityToEdit.efficiency ? 'var(--accent)' : 'rgba(255, 255, 255, 0.05)'}; border: 1px solid rgba(255, 255, 255, 0.1); color: ${val === activityToEdit.efficiency ? 'var(--primary)' : 'var(--text)'}; cursor: pointer;">
                                    ${val}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--accent);">Notes</label>
                        <textarea id="editNotes" rows="3" style="width: 100%; padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); color: var(--text);">${activityToEdit.notes || activityToEdit.progress || ''}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="cancelEditBtn" style="flex: 1; padding: 12px; border-radius: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text); cursor: pointer;">Cancel</button>
                        <button type="submit" style="flex: 1; padding: 12px; border-radius: 8px; background: var(--accent); border: none; color: var(--primary); font-weight: 600; cursor: pointer;">Save Changes</button>
                    </div>
                </form>
            `;
            
            editFormContainer.innerHTML = formHtml;
            editModal.classList.add('active');
            
            // Add event listeners for edit form
            const form = document.getElementById('editActivityForm');
            const cancelBtn = document.getElementById('cancelEditBtn');
            const efficiencyBtns = document.querySelectorAll('.efficiency-edit-btn');
            let selectedEfficiency = activityToEdit.efficiency;
            
            efficiencyBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    efficiencyBtns.forEach(b => {
                        b.style.background = 'rgba(255, 255, 255, 0.05)';
                        b.style.color = 'var(--text)';
                    });
                    btn.style.background = 'var(--accent)';
                    btn.style.color = 'var(--primary)';
                    selectedEfficiency = parseInt(btn.dataset.value);
                });
            });
            
            cancelBtn.addEventListener('click', () => {
                editModal.classList.remove('active');
                activityToEdit = null;
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateActivity(selectedEfficiency);
            });
        }

        async function updateActivity(efficiency) {
            try {
                const task = document.getElementById('editTask').value;
                const date = document.getElementById('editDate').value;
                const timeFrom = document.getElementById('editTimeFrom').value;
                const timeTo = document.getElementById('editTimeTo').value;
                const notes = document.getElementById('editNotes').value;
                
                // Create new date objects
                const startDate = new Date(`${date}T${timeFrom}`);
                const endDate = new Date(`${date}T${timeTo}`);
                
                // Handle spanning midnight
                if (endDate < startDate) {
                    endDate.setDate(endDate.getDate() + 1);
                }
                
                // Calculate duration
                const durationMs = endDate - startDate;
                const durationMinutes = Math.floor(durationMs / (1000 * 60));
                
                // Prepare update data
                const updateData = {
                    taskName: task,
                    task: task,
                    startAt: firebase.firestore.Timestamp.fromDate(startDate),
                    endAt: firebase.firestore.Timestamp.fromDate(endDate),
                    efficiency: efficiency,
                    notes: notes,
                    progress: notes,
                    duration: durationMinutes,
                    durationHours: Math.floor(durationMinutes / 60),
                    durationMinutes: durationMinutes % 60,
                    timeFrom: timeFrom,
                    timeTo: timeTo,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Update in Firestore
                await db.collection('activities').doc(activityToEdit.id).update(updateData);
                
                // Close modal and reload
                editModal.classList.remove('active');
                activityToEdit = null;
                
                // Show success message
                alert('Activity updated successfully!');
                
                // Reload activities
                loadActivities();
                
            } catch (error) {
                console.error('Error updating activity:', error);
                alert('Error updating activity. Please try again.');
            }
        }

        async function deleteActivity() {
            if (!activityToDelete) return;
            
            try {
                await db.collection('activities').doc(activityToDelete).delete();
                console.log("Activity deleted successfully");
                
                // Close the confirmation popup
                deleteConfirmationPopup.classList.remove('active');
                
                // Remove from local arrays
                allActivities = allActivities.filter(a => a.id !== activityToDelete);
                filteredActivities = filteredActivities.filter(a => a.id !== activityToDelete);
                
                // Update UI
                filterAndDisplayActivities();
                
            } catch (error) {
                console.error('Error deleting activity: ', error);
                alert('Error deleting activity. Please try again.');
            } finally {
                activityToDelete = null;
            }
        }

        function updateStatistics(activities) {
            if (!activities || activities.length === 0) {
                totalActivitiesEl.textContent = '0';
                totalHoursEl.textContent = '0h 0m';
                avgEfficiencyEl.textContent = '0.0';
                productiveHoursEl.textContent = '0h 0m';
                taskBreakdownEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No task data available</p>';
                return;
            }

            // Update basic statistics
            totalActivitiesEl.textContent = activities.length;
            
            // Calculate total time
            const totalMinutes = activities.reduce((sum, activity) => {
                return sum + (activity.duration || 0);
            }, 0);
            totalHoursEl.textContent = formatDuration(totalMinutes);
            
            // Calculate average efficiency
            const totalEfficiency = activities.reduce((sum, activity) => {
                return sum + (activity.efficiency || 0);
            }, 0);
            const avgEfficiency = activities.length > 0 
                ? (totalEfficiency / activities.length).toFixed(1)
                : '0.0';
            avgEfficiencyEl.textContent = avgEfficiency;
            
            // Calculate productive time (activities with efficiency >= 1)
            const productiveMinutes = activities
                .filter(activity => (activity.efficiency || 0) >= 1)
                .reduce((sum, activity) => sum + (activity.duration || 0), 0);
            productiveHoursEl.textContent = formatDuration(productiveMinutes);
            
            // Update task breakdown
            const taskStats = {};
            activities.forEach(activity => {
                const task = activity.taskName || activity.task || 'Unknown Task';
                if (!taskStats[task]) {
                    taskStats[task] = {
                        duration: 0,
                        count: 0
                    };
                }
                taskStats[task].duration += (activity.duration || 0);
                taskStats[task].count += 1;
            });
            
            let taskHtml = '';
            Object.keys(taskStats).forEach(task => {
                const stats = taskStats[task];
                taskHtml += `
                    <div class="task-item">
                        <div class="task-name">${task}</div>
                        <div class="task-stats">
                            <div class="task-duration">${formatDuration(stats.duration)}</div>
                            <div class="task-count">${stats.count} activities</div>
                        </div>
                    </div>
                `;
            });
            
            taskBreakdownEl.innerHTML = taskHtml;
        }

        function updateAccuracyDashboard() {
            const dateRange = getAccuracyDateRange(currentAccuracyRange);
            const metrics = calculateAccuracyMetrics(allActivities, dateRange);
            renderAccuracyDashboard(metrics, currentAccuracyRange);
        }

        // ============================
        // Event Listeners
        // ============================
        dateFilter.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRange.style.display = 'block';
                customDateRangeEnd.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
                customDateRangeEnd.style.display = 'none';
            }
            currentPage = 1;
            loadActivities();
        });

        taskFilter.addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayActivities();
        });

        efficiencyFilter.addEventListener('change', () => {
            currentPage = 1;
            filterAndDisplayActivities();
        });

        startDateInput.addEventListener('change', () => {
            currentPage = 1;
            loadActivities();
        });

        endDateInput.addEventListener('change', () => {
            currentPage = 1;
            loadActivities();
        });
        
        // Accuracy date selector
        accuracyDateSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('date-btn-small')) {
                document.querySelectorAll('.date-btn-small').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentAccuracyRange = e.target.dataset.range;
                updateAccuracyDashboard();
            }
        });
        
        // Pagination event listeners
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayPaginatedActivities();
            }
        });
        
        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredActivities.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                displayPaginatedActivities();
            }
        });
        
        // Delete confirmation event listeners
        cancelDeleteBtn.addEventListener('click', () => {
            deleteConfirmationPopup.classList.remove('active');
            activityToDelete = null;
        });
        
        confirmDeleteBtn.addEventListener('click', deleteActivity);
        
        // Edit modal close
        closeEditModal.addEventListener('click', () => {
            editModal.classList.remove('active');
            activityToEdit = null;
        });

        // ============================
        // Initialize
        // ============================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing...");
            setTimeout(() => {
                loadActivities();
            }, 1000);
        });
    </script>
</body>
</html>
